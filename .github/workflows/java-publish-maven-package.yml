name: Publish Java Package to GitHub Packages

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        default: '21'
        type: string
      skip-tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest

    # GitHub Packages Maven registry requires these
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}
          cache: 'maven'
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute project version
        id: version
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          echo "Current branch: $BRANCH"

          # If on main, determine version
          if [[ "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
            if [[ -z "$TAG" ]]; then
              VERSION="1.0.${GITHUB_RUN_NUMBER}"
            else
              VERSION="$TAG"
            fi
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}-SNAPSHOT"
          fi

          echo "Using version: $VERSION"
          mvn -B versions:set -DnewVersion=${VERSION}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run tests
        if: ${{ !inputs.skip-tests }}
        run: mvn -B test

      - name: Build JAR package
        run: mvn -B clean package -DskipTests

      - name: Publish to GitHub Packages
        if: github.ref_name == 'main' || github.ref_name == 'master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Deploying version ${{ steps.version.outputs.version }}..."
          mvn -B deploy -DskipTests
