name: Publish Java Package to GitHub Packages

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        default: '21'
        type: string
      skip-tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}
          cache: 'maven'
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          settings-path: ${{ github.workspace }}

      - name: Run tests
        if: ${{ !inputs.skip-tests }}
        run: mvn -B test --settings ${{ steps.setup-java.outputs.settings-path }}/settings.xml

      - name: Package JAR
        run: mvn -B clean package -DskipTests --settings ${{ steps.setup-java.outputs.settings-path }}/settings.xml

      - name: Publish to GitHub Packages
        if: github.ref_name == 'main' || github.ref_name == 'master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: mvn -B deploy -DskipTests --settings ${{ steps.setup-java.outputs.settings-path }}/settings.xml
